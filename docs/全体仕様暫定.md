**以下の仕様は初期段階で作成した暫定的なもので、未決定事項・仮置きが多いです。なので、各仕様の詳細を決定する際には変更する可能性が高いことを念頭においてください。**

# 1) 目的・スコープ

* **目的**: 自然言語のテストケースを入力として、事前定義された約80件の「手順（Procedure）」を**組み合わせた実行手順**を自動生成する。
* **対象領域**: テスト設計の補助（手順化）。テストの実行や外部ツール連携（RPA/TestRail/Jira等）は**非対象**（将来拡張）。

# 2) システム全体像（AWS/ECS）

* **ランタイム**: AWS ECS on EC2
* **コンポーネント**

  * **FastAPI サービス（アプリ）**: テストケース受付／プロンプト合成／LLM呼出／応答整形と正規化
  * **Ollama（LLMサーバ）**: OpenAI互換スキーマでの推論提供（初期は FastAPI と**同一タスクのサイドカー**運用を想定）
* **ネットワーク**: 研究開発段階は**社内ネットワーク限定**。将来は外部公開を視野（詳細は §9）。
* **スケール**: ECS Service のオートスケール（将来、必要なら Ollama を別サービスへ分離し独立スケール）

# 3) 入出力フロー（基本処理）

1. **入力受領**: 自然言語のテストケースと「**手順辞書**」（標準手順）および「**ユーザ定義手順**」を受け取る
2. **プロンプト合成**: テンプレート（編集しやすい分割構成）に、テストケース／手順辞書（標準）／ユーザ定義手順を埋め込み
3. **LLM 推論**: Ollama（OpenAI互換）へリクエスト（モデルは実験的に切替可能／例：`gpt-oss:20b`）
4. **検証・整形**: 応答を **JSON Schema** で検証→不足/不整合は再試行1回まで→`id`と`params`の必須フィールドを満たす形に正規化
5. **近似候補提示**: 辞書と一致しない要求は、**最も近い候補**（複数可）を併記
6. **応答返却**: 生成手順＋メタ（使用モデル、プロンプト版、レイテンシ等）

# 4) 外部インターフェース（API 仕様）

## 4.1 生成エンドポイント

* **POST** `/v1/test-procedures:generate`
* **Request (例)**

```json
{
  "test_case_text": "ユーザーがログイン後に商品検索を行い、結果一覧から…",
  "default_actions": {       // 標準手順辞書
    "WIN-ACT-DEFAULT-023": {
      "action_code": "WIN-ACT-DEFAULT-023",
      "name": {"ja": "文字列を入力する"},
      "format": {"ja": "「画面名」画面の「要素名」に「設定値」を入力する"},
      "basic_operation": "valtes keybord type text ${screen} ${element} ${value}"
    }
  },
  "user_defined_actions": [ // ユーザ定義手順（サーバー側保存なし）
    {
      "action_code": "USER-001",
      "name": {"ja": "右クリックメニュー操作"},
      "format": {"ja": "「アプリ名」の「メニュー項目」を右クリックして「操作」を実行する"}
    }
  ],
  "options": {
    "model": "gpt-oss:20b",     // 省略時は既定モデル
    "locale": "ja-JP",
    "max_steps": 50
  }
}
```

* **Response（概念）**

```json
{
  "trace_id": "req_123",
  "summary": "ログイン→検索→結果確認の順で手順を組成",
  "steps": [
    { "id": "LOGIN_BASIC", "params": {"画面名": "ログイン", "要素名": "ID", "設定値": "tester"} },
    { "id": "SEARCH_PRODUCT", "params": {"画面名": "検索", "要素名": "キーワード", "設定値": "USB-C"} }
  ],
  "nearest_candidates": [
    { "original_requirement": "結果のスクリーンショット保存",
      "candidates": [{ "id": "CAPTURE_SCREEN", "similarity": 0.82 }] }
  ],
  "meta": {
    "model": "gpt-oss:20b",
    "prompt_version": "testproc/v1",
    "latency_ms": 620
  }
}
```

## 4.2 健全性

* **GET** `/healthz`, `/readyz`

# 5) データモデル／スキーマ

## 5.1 生成結果の最小要件

* **必須**: `id`, `params`
* **推奨**: `depends_on`, `tags`, `notes`
* **近似候補**: `nearest_candidates`（`original_requirement`, `candidates[{id, similarity}]`）

## 5.2 手順辞書（Procedure Catalog）

* **標準手順辞書**:
  - **件数**: 約80件
  - **構造例**:
    ```json
    "WIN-ACT-DEFAULT-023": {
      "action_code": "WIN-ACT-DEFAULT-023",
      "sort_number": 23,
      "action_type": "operation",
      "name": {"ja": "文字列を入力する", "en": "Enter Text"},
      "format": {"ja": "「画面名」画面の「要素名」に「設定値」を入力する"},
      "basic_operation": "valtes keybord type text ${screen} ${element} ${value}",
      "restriction_type": 5
    }
    ```
  
* **ユーザ定義手順**:
  - ユーザが独自に定義した手順（**サーバー側保存なし**、リクエスト毎に受け取り）
  - 標準手順辞書と同様の構造を持つが、`action_code`は"USER-"プレフィックスを推奨
  
* **項目仕様**:
  - `action_code`: 手順の一意識別子
  - `name`: 手順の名称（多言語対応）
  - `format`: 自然言語での手順テンプレート（多言語対応）
  - `basic_operation`: 実行コマンド（省略可）
  
* **マッチング**: LLM へ標準手順辞書とユーザ定義手順を提示して候補抽出。完全一致しない場合は**最も近い候補**を提示。

## 5.3 プロンプト管理

* **ファイル管理**: 1テンプレートあたり1ファイルとして簡易管理
* **バージョン**: `testproc/v1` などの論理名で切替可能（レスポンスに明示）
* **保持**: 研究用途として**プロンプト本文を保存**（保持期間/マスキングはTBD）

# 6) LLM 運用要件（Ollama 前提）

* **API**: OpenAI 互換（/v1/chat/completions など）
* **モデル**: 実験的に複数（例：`gpt-oss:20b`）。リクエストの `options.model` で選択可
* **出力安定化**: JSONモード相当の指示＋**JSON Schema 検証**と**自動リカバリ再試行（最大1回）**
* **将来拡張**: 必要に応じて Ollama を ECS 別サービス化／別プロバイダ追加（その際もAPIは不変）

# 7) ロギング／観測性

* **アプリログ**: CloudWatch Logs（`trace_id`、使用モデル/プロンプト**版**、レイテンシ、再試行回数）
* **監査**: プロンプト本文の保持（PII等のマスキング方針は **TBD**）
* **メトリクス例**: p50/p95 レイテンシ、スキーマ検証失敗率、近似候補提示率、LLM エラー率

# 8) 運用・構成管理（方針）

* **設定**: SSM Parameter Store / Secrets Manager（APIトークン、Ollama接続先 等）
* **バージョン追跡**: 応答に `prompt_version` を常に付与
* **モデル切替**: 既定モデルは環境変数で指定、リクエストで上書き可
* **プロンプト**: リポジトリで版管理し、必要に応じてS3等へ同期（ホットスワップ可能）

# 9) セキュリティ／公開範囲

* **現状**: 社内ネットワーク限定（VPC内、SGで最小許可）
* **将来**: 外部公開時は認証方式を選定（候補：OIDC、Token、IP制限、WAF 併用）。TLS は ACM を使用
  ※最終方式・ポリシーは **TBD**

# 10) 非機能要件（初期ポリシー）

* **性能**: 公式SLAは **未設定（TBD）**。まずは計測基盤を整備し、後から目標値を設定
* **可用性**: ECS のヘルスチェックとオートスケールに準拠
* **拡張性**: モデル追加／辞書拡充／プロンプト改良に対して API 不変を基本方針

# 11) 品質ゲート（受け入れ観点）

* 入力→出力が**常に `id`/`params` を満たす**（JSON Schema 合格）
* 一致しない要求が含まれる場合、**最も近い候補**を**理由（similarity等）付き**で返す
* 応答に `model/prompt_version/latency_ms` を**必ず含める**
* ヘルスチェックが ALB/ECS 基準を満たす
* ログに `trace_id` が付与され、追跡可能

---

## 最終メッセージ

* **作るべきもの**は、ECS上の FastAPI サービスと Ollama を中核に、
  \*\*自然言語のテストケース→辞書ベース手順（`id`/`params`）\*\*を出力する変換システム。
* **編集しやすいプロンプト**とリクエストで受け取る**手順辞書**を用い、**近似候補提示**で曖昧さに対応。
* **社内限定運用**から始め、**計測→目標値設定→外部公開**へ段階的に進める。
