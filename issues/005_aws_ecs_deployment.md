# Issue #005: AWS ECSデプロイ構成の実装

## タイトル
AWS ECSデプロイ構成の実装

## 概要
AWS ECS on EC2でのコンテナデプロイメント構成を実装する。FastAPIとOllamaのサイドカー構成、オートスケール設定、セキュリティ設定を含む。

## 詳細
- Dockerfileの作成（FastAPI、Ollama）
  - FastAPI用とOllama用のDockerイメージを作成するための設定ファイル
  - アプリケーションの実行環境とOSレベルの依存関係を定義
  - ECR（Elastic Container Registry）にプッシュするためのベースイメージとして必要
- docker-compose.ymlの作成（ローカル開発用）
  - 本番環境デプロイ前にローカル環境でコンテナ連携をテスト・検証するため
  - FastAPIとOllamaの接続確認、ポートマッピング、環境変数の設定確認に使用
  - ECS本番環境との設定差分を最小化するためのリファレンス実装
- ECS Task Definitionの設計
  - ECSでコンテナを実行するための「設計図」的な設定ファイル
  - CPUやメモリの割り当て、コンテナイメージの指定、ネットワーク設定を定義
  - 本番環境でのリソース効率と安定稼働の基盤となる重要な設定
- FastAPIとOllamaのサイドカー構成
  - 1つのECSタスク内で複数コンテナを連携実行する構成パターン
  - FastAPIがOllamaにlocalhostでアクセスできるため通信が高速・安全
  - コンテナ間の密結合が必要なアプリケーションに適した設計手法
- ECS Serviceの設定（オートスケール）
  - 指定した数のタスクを常に実行状態に保つECSの管理機能
  - CPU使用率やリクエスト数に応じて自動でタスク数を増減させる設定
  - サービスの可用性確保とコスト最適化を両立するために必須
- ALB（Application Load Balancer）設定
  - インターネットからのHTTPSリクエストを複数のECSタスクに分散する仕組み
  - ヘルスチェック機能により異常なタスクを自動的に切り離し
  - SSL/TLS終端とドメインベースルーティングの中心的役割
- VPC、セキュリティグループ設定
  - ECSタスクが実行されるプライベートネットワーク環境の構築
  - ファイアウォール機能としてアクセス可能なポートとIPアドレス範囲を制御
  - インターネットからの不正アクセスを防ぐセキュリティの最前線
- SSM Parameter Store / Secrets Manager連携
  - APIキーやデータベースパスワードなど機密情報の安全な管理・配布
  - コンテナイメージやソースコードに機密情報をハードコーディングしない仕組み
  - 設定変更時にイメージ再ビルド不要で運用効率を向上させる
- TLS証明書設定（ACM）
  - HTTPS通信を実現するためのSSL/TLS証明書の自動管理サービス
  - ブラウザの「安全でない接続」警告を回避し、通信内容の暗号化を保証
  - 証明書の更新作業を自動化してセキュリティ運用負荷を軽減
- IAMロール・ポリシー設定
  - ECSタスクやALBが他のAWSサービスにアクセスするための権限管理
  - 「最小権限の原則」に基づいて必要最小限のアクセス権限のみを付与
  - セキュリティインシデント防止とコンプライアンス要件対応の基盤

## 受け入れ条件
- [ ] DockerイメージがビルドされECRに登録される
- [ ] ECSタスクが正常に起動する
- [ ] FastAPIとOllamaが同一タスク内で連携動作する
- [ ] ALBを通じてAPIにアクセス可能
- [ ] オートスケールが動作する
- [ ] セキュリティグループが適切に設定される
- [ ] 設定情報がSSM/Secrets Managerから取得される

## 関連仕様
- システム全体像（AWS/ECS）
- セキュリティ／公開範囲
- 運用・構成管理（設定管理）
- 非機能要件（可用性、拡張性）

# sub-issue

## Task 1: FastAPI用Dockerfile作成

### 実装ステップ
- Python公式イメージをベースとしたDockerfileの作成
  - 軽量で安定したPython実行環境を提供するため
- requirements.txtからの依存関係インストール
  - FastAPIとその必要なライブラリをコンテナ内にセットアップするため
- アプリケーションコードのコピーと配置
  - 本番環境で実行するFastAPIアプリケーションを組み込むため
- EXPOSE 8000の設定とCMD実行コマンド定義
  - ECSからのHTTPアクセスを受け付ける設定を行うため

### ユニットテスト
- Dockerイメージのビルド成功テスト
- コンテナ起動とポート8000での応答テスト
- FastAPIアプリケーションのヘルスチェック確認テスト

## Task 2: Ollama用Dockerfile作成

### 実装ステップ
- ollama/ollama公式イメージの使用
  - Ollamaサービスの安定した実行環境を確保するため
- 必要なLLMモデルの事前ダウンロード設定
  - コンテナ起動時にモデル読み込み時間を短縮するため
- API待ち受けポート11434の設定
  - FastAPIからのLLM推論リクエストを受け付けるため

### ユニットテスト
- Ollamaコンテナの正常起動テスト
- ポート11434でのAPI応答テスト
- モデル推論機能の動作確認テスト

## Task 3: docker-compose.yml作成

### 実装ステップ
- fastapi-appとollama-serviceの2サービス定義
  - ローカル開発環境でのコンテナ連携テストを実現するため
- 内部ネットワークでの通信設定
  - FastAPIからOllamaへのHTTP通信を可能にするため
- 環境変数とポートマッピングの設定
  - 開発時の設定とデバッグアクセスを提供するため

### ユニットテスト
- docker-compose upでの全サービス起動テスト
- FastAPIからOllamaへの通信確認テスト
- 外部からのFastAPI APIアクセステスト

## Task 4: ECS Task Definition作成

### 実装ステップ
- EC2モード用Task Definition JSONファイルの作成
  - GPU使用可能なEC2インスタンスでの実行を可能にするため
- FastAPIとOllamaコンテナの定義をサイドカー構成で設定
  - 同一タスク内での高速なコンテナ間通信を実現するため
- GPU設定（resourceRequirements）とCPU・メモリリソースの割り当て
  - Ollama推論でのGPU使用とMVP動作に必要なリソースを確保するため
- CloudWatch Logsへのログ出力設定
  - 本番環境でのログ監視を可能にするため

### ユニットテスト
- Task Definition JSON形式の妥当性確認テスト
- リソース設定値の正当性確認テスト
- ログ設定の動作確認テスト

## Task 5: 基本的なIAM権限設定

### 実装ステップ
- ECS Task実行ロール（ecsTaskExecutionRole）の作成
  - ECRからのイメージPullとCloudWatch Logsへの出力を可能にするため
- 必要最小限のポリシーアタッチメント
  - セキュリティを確保しつつECSタスクの基本動作を実現するため
- ECS Serviceからタスクを起動するための権限設定
  - ECS上でのタスク管理機能を動作させるため

### ユニットテスト
- IAMロール作成の成功確認テスト
- ECSタスク実行権限の動作確認テスト
- 不要な権限が付与されていないことの確認テスト
