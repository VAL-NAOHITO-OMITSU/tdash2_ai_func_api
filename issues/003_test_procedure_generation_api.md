# Issue #003: テスト手順生成APIの実装

## タイトル
テスト手順生成APIの実装

## 概要
自然言語のテストケースを受け取り、事前定義された手順の組み合わせを生成するメインAPIを実装する。JSONスキーマ検証、再試行機能、近似候補提示機能を含む。

## 詳細
- `POST /v1/test-procedures:generate` エンドポイントの実装
- リクエスト/レスポンスのJSONスキーマ定義と検証
- 入力データの検証とサニタイゼーション
- LLM応答のJSON Schema検証機能
- スキーマ検証失敗時の自動再試行（最大1回）
- 近似候補提示機能の実装
- trace_id による処理追跡
- エラーハンドリングとエラーレスポンス

## 受け入れ条件
- [ ] APIエンドポイントが仕様通りのリクエスト/レスポンスを処理する
- [ ] JSON Schemaによる入力検証が機能する
- [ ] LLM応答の検証機能が動作する
- [ ] 近似候補提示機能が動作する
- [ ] trace_id機能（Issue 001で実装された基盤機能）が適切に動作する
- [ ] エラーケースが適切にハンドリングされる

## 関連仕様
- 入出力フロー（基本処理）
- 外部インターフェース（API 仕様）
- データモデル／スキーマ
- 品質ゲート（受け入れ観点）

# sub-issue

## Task 1: APIエンドポイント基盤の実装

### 実装ステップ
- `POST /v1/test-procedures:generate` エンドポイントの基本構造作成
  - FastAPIルーターの実装により、テスト手順生成APIの入り口を確立し、リクエストルーティングの基盤を構築する
- APIルーターの登録とパス設定
  - アプリケーション全体のルーティング構成への統合により、エンドポイントの一元管理と保守性を確保する
- 基本的なリクエスト/レスポンス構造の定義
  - Pydanticモデルを使用した型安全なデータ処理により、API仕様の明確化と実行時エラーの防止を実現する
- エンドポイント関数のスケルトン実装
  - 処理フローの骨格作成により、後続の詳細実装における一貫性と拡張性を確保する

### ユニットテスト
- エンドポイントの存在確認テスト
- 基本的なHTTPメソッドの動作テスト
- ルーティングの正確性テスト
- 最小限のリクエスト/レスポンスのテスト

## Task 2: リクエストJSONスキーマの実装

### 実装ステップ
- リクエストボディのPydanticモデル作成
  - 入力データ構造の明確な定義により、型安全性の確保とAPIドキュメントの自動生成を実現する
- 必須フィールドとオプショナルフィールドの定義
  - データ要件の明確化により、クライアント側での適切なリクエスト構築を支援し、処理エラーを防止する
- フィールドバリデーションルールの実装
  - 文字列長制限、形式チェック、値の範囲検証により、不正データの早期検出とシステムの安定性を確保する
- カスタムバリデーター関数の作成
  - ビジネスロジックに特化した検証により、アプリケーション要件への適合性とデータ品質を保証する

### ユニットテスト
- 正常なリクエストデータの検証テスト
- 必須フィールド欠落時のエラーテスト
- フィールド形式違反時のバリデーションテスト
- カスタムバリデーションルールのテスト

## Task 3: レスポンスJSONスキーマの実装

### 実装ステップ
- レスポンスボディのPydanticモデル作成
  - 出力データ構造の標準化により、クライアント側での一貫したレスポンス処理と型安全性を実現する
- 成功レスポンスのスキーマ定義
  - 正常処理結果の構造化により、クライアント側でのデータ活用効率とAPI利用体験を向上させる
- エラーレスポンスのスキーマ定義
  - エラー情報の標準化により、クライアント側での適切なエラーハンドリングとユーザーへの明確な情報提示を可能にする
- trace_idを含むレスポンスヘッダー定義
  - リクエスト追跡識別子の提供により、問題発生時の迅速な原因特定とサポート対応を効率化する

### ユニットテスト
- 成功レスポンス形式の確認テスト
- エラーレスポンス形式の確認テスト
- trace_id出力の確認テスト
- レスポンススキーマの妥当性テスト

## Task 4: 入力データ検証機能の実装

### 実装ステップ
- リクエストデータのサニタイゼーション機能
  - 危険な文字や不正なスクリプトの除去により、セキュリティリスクの軽減とデータの安全性を確保する
- テストケース文字列の形式検証
  - 自然言語テストケースの構造確認により、後続のLLM処理での効率性と結果品質を向上させる
- 文字数制限と文字種制限の実装
  - 処理リソースの保護と不正データの排除により、システムの安定性とパフォーマンスを維持する
- 入力データの正規化処理
  - データ形式の統一により、後続処理での一貫性とLLM応答の品質向上を実現する

### ユニットテスト
- サニタイゼーション機能の動作テスト
- 文字数制限の確認テスト
- 不正文字の検出・除去テスト
- 正規化処理の正確性テスト

## Task 5: LLM統合基盤の実装

### 実装ステップ
- LLMクライアント接続の実装
  - 外部LLMサービスとの安全で効率的な通信により、テスト手順生成処理の中核機能を確立する
- プロンプトテンプレート管理機能の実装
  - 1テンプレートあたり1ファイルによる簡易管理とバージョン管理（testproc/v1等）による運用性を確保する
- プロンプト合成とデータ埋め込み機能の実装
  - テストケース・フォーマット一覧・受信手順辞書を固定テンプレートに動的に埋め込み、完全なLLM指示を生成する
- 最小限データ保存機能の実装
  - 入力データ（test_case_text, format_list）と処理結果は完全保存し、プロンプトテンプレートはハッシュのみ保存してオーバーヘッドを最小化する
- LLM応答の受信とパース機能
  - 外部サービスからの応答データを適切に処理することで、システム内でのデータ活用と後続処理を可能にする
- 接続エラーハンドリングの実装
  - 外部サービス依存による障害の適切な処理により、システム全体の可用性とユーザー体験を維持する

### ユニットテスト
- LLMクライアント接続テスト
- プロンプトテンプレート読み込みと管理テスト
- データ埋め込みによるプロンプト合成テスト
- バージョン管理機能のテスト
- データ保存機能（完全保存・ハッシュ保存）のテスト
- 応答パース機能のテスト
- 接続エラー時の動作テスト

## Task 6: LLM応答JSON Schema検証機能の実装

### 実装ステップ
- LLM応答のJSONスキーマ定義
  - 期待される応答構造の明確化により、後続処理での型安全性と処理の確実性を保証する
- 応答データの構造検証機能
  - LLM出力の形式確認により、不正な応答データによるシステム障害を防止し、処理の信頼性を確保する
- スキーマ違反の詳細エラー情報生成
  - 検証失敗時の具体的な問題箇所の特定により、問題の迅速な診断と対応を可能にする
- 部分的な応答データの救済機能
  - 一部不正な応答からの有効部分の抽出により、処理効率の向上とユーザー体験の改善を実現する

### ユニットテスト
- 正常なLLM応答の検証テスト
- スキーマ違反応答の検出テスト
- エラー詳細情報の確認テスト
- 部分救済機能の動作テスト

## Task 7: 近似候補提示機能の実装

### 実装ステップ
- 類似手順の検索アルゴリズム実装
  - 既存手順データからの類似度計算により、ユーザーの意図に近い手順候補の効率的な発見を実現する
- 候補スコアリングシステムの構築
  - 候補の品質を数値化することで、ユーザーにとって最も有用な候補の優先的な提示を可能にする
- 候補データの整形と提示機能
  - 候補情報の見やすい形式への変換により、ユーザーの選択効率と利用体験を向上させる
- 提示候補数の制限と品質フィルタリング
  - 情報過多の防止と低品質候補の除外により、ユーザーの意思決定効率と満足度を向上させる

### ユニットテスト
- 類似度計算アルゴリズムのテスト
- スコアリングシステムの正確性テスト
- 候補整形機能のテスト
- フィルタリング機能のテスト

## Task 8: 統合エラーハンドリングの実装

### 実装ステップ
- API固有のエラー分類システム
  - 各種エラー状況の体系的な分類により、適切なエラー処理と明確なユーザーフィードバックを実現する
- HTTPステータスコードとエラーコードのマッピング
  - 標準的なHTTPステータスとアプリケーション固有エラーの対応により、クライアント側での効率的なエラー処理を支援する
- エラーメッセージの標準化とフォーマット統一
  - 一貫したエラー情報の提供により、クライアント側での効率的なエラーハンドリングとデバッグ支援を実現する
- エラー発生時のクリーンアップ処理
  - 処理途中でのエラー時のリソース解放により、システムの安定性とメモリリークの防止を確保する

### ユニットテスト
- 各種エラー分類の動作テスト
- HTTPステータスコードマッピングテスト
- エラーメッセージフォーマットテスト
- クリーンアップ処理の確認テスト